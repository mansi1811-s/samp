# name: GitHub Actions Demo
# run-name: ${{ github.actor }} is testing out GitHub Actions 🚀
# on: [push]
# jobs:
#   Explore-GitHub-Actions:
#     runs-on: ubuntu-latest
#     steps:
#       - run: echo "🎉 The job was automatically triggered by a ${{ github.event_name }} event."
#       - run: echo "🐧 This job is now running on a ${{ runner.os }} server hosted by GitHub!"
#       - run: echo "🔎 The name of your branch is ${{ github.ref }} and your repository is ${{ github.repository }}."
#       - name: Check out repository code
#         uses: actions/checkout@v4
#       - run: echo "💡 The ${{ github.repository }} repository has been cloned to the runner."
#       - run: echo "🖥️ The workflow is now ready to test your code on the runner."
#       - name: List files in the repository
#         run: |
#           ls ${{ github.workspace }}
#       - run: echo "🍏 This job's status is ${{ job.status }}."

name: Build and Scan Docker Image

on:
  push:
    branches:
      - main  # Change this to your main branch name

jobs:
  build_and_scan:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Set up Docker
      uses: docker/setup-buildx-action@v3
      # with:
      #   version: 20.10.7   # Adjust the Docker version as needed

    - name: Build Docker Image
      run: |
        docker build -t trapp:v1 .
      # working-directory: path/to/your/app  # Set the path to your app if necessary

    - name: Set up Trivy
      run: |
        curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin
      shell: bash

    - name: Scan Docker Image with Trivy
      run: |
        trivy image --severity=HIGH trapp:v1
      shell: bash

    - name: Set up CodeQL
      run: |
        codeqlURL=$(curl -s https://api.github.com/repos/github/codeql-cli-binaries/releases/latest | jq -r '.assets[].browser_download_url | select(contains("codeql-bundle"))')
        curl -L -o codeql-bundle.tar.gz $codeqlURL
        tar xzf codeql-bundle.tar.gz
        export PATH=$PATH:$PWD/codeql-bundle-*
      shell: bash


    - name: Build CodeQL database
      run: |
        codeql database create python-database --language=python --source-root .
        codeql database analyze python-database mansi1811-s/samp
      shell: bash

    - name: Upload CodeQL results
      uses: github/codeql-action/upload-sarif@v1
      with:
        sarif_file: codeql-database/results.sarif


